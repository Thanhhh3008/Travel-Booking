<%- include('./layout/header') %>

<div class="container mt-4">
  <h3>üìÑ Chi ti·∫øt Ng∆∞·ªùi d√πng</h3>

  <form id="editForm">
    <table class="table table-bordered mt-3" id="userTable">
      <tr>
        <th>M√£ ng∆∞·ªùi d√πng</th>
        <td><%= user.MaNguoiDung %></td>
      </tr>

      <tr>
        <th>H·ªç t√™n</th>
        <td class="editable" data-field="HoTen">
          <%= user.HoTen || '' %>
        </td>
      </tr>

      <tr>
        <th>Ng√†y sinh</th>
        <td class="editable" data-field="NgaySinh">
          <%= user.NgaySinh ? new Date(user.NgaySinh).toISOString().split('T')[0] : '' %>
        </td>
      </tr>

      <tr>
        <th>Username</th>
        <td><%= user.Username %></td>
      </tr>

      <tr>
        <th>Email</th>
        <td class="editable" data-field="Email">
          <%= user.Email || '' %>
        </td>
      </tr>

      <tr>
        <th>ƒê·ªãa ch·ªâ</th>
        <td class="editable" data-field="DiaChi">
          <%= user.DiaChi || '' %>
        </td>
      </tr>

      <tr>
        <th>SƒêT</th>
        <td class="editable" data-field="SDT">
          <%= user.SDT || '' %>
        </td>
      </tr>

      <tr>
        <th>Qu·ªëc t·ªãch</th>
        <td class="editable" data-field="QuocTich">
          <%= user.QuocTich || '' %>
        </td>
      </tr>

      <tr>
        <th>Vai tr√≤</th>
        <td class="editable"
            data-field="MaVaiTro"
            data-type="select"
            data-current="<%= user.MaVaiTro %>">

          <span class="role-text">
            <%= roles.find(r => String(r.MaVaiTro) === String(user.MaVaiTro))?.TenVaiTro || 'Ch∆∞a c√≥ vai tr√≤' %>
          </span>
        </td>
      </tr>
    </table>

    <div class="d-flex justify-content-end gap-2 mt-3">
      <a href="/admin/user" class="btn btn-secondary">‚¨ÖÔ∏è Quay l·∫°i</a>
      <button type="button" id="editBtn" class="btn btn-warning">‚úèÔ∏è S·ª≠a</button>
      <button type="button" id="saveBtn" class="btn btn-success d-none">üíæ L∆∞u</button>
      <a href="/admin/user/delete/<%= user.MaNguoiDung %>"
         class="btn btn-danger"
         onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y kh√¥ng?')">
        üóëÔ∏è X√≥a
      </a>
    </div>
  </form>
</div>

<script>
  const editBtn = document.getElementById('editBtn');
  const saveBtn = document.getElementById('saveBtn');
  const table = document.getElementById('userTable');
  const userId = "<%= user.MaNguoiDung %>";
  const roles = <%- JSON.stringify(roles) %>;

  /* ====== B·∫¨T CH·∫æ ƒê·ªò S·ª¨A ====== */
  editBtn.addEventListener('click', () => {
    table.querySelectorAll('.editable').forEach(td => {

      if (td.dataset.type === 'select') {
        const current = td.dataset.current;
        const options = roles.map(r => `
          <option value="${r.MaVaiTro}" ${String(r.MaVaiTro) === String(current) ? 'selected' : ''}>
            ${r.TenVaiTro}
          </option>
        `).join('');

        td.innerHTML = `
          <select class="form-select" name="${td.dataset.field}">
            ${options}
          </select>
        `;
      } 
      else {
        const value = td.textContent.trim();
        td.innerHTML = `
          <input type="text"
                 class="form-control"
                 name="${td.dataset.field}"
                 value="${value}">
        `;
      }
    });

    editBtn.classList.add('d-none');
    saveBtn.classList.remove('d-none');
  });

  /* ====== L∆ØU D·ªÆ LI·ªÜU ====== */
  saveBtn.addEventListener('click', async () => {
    const formData = {};
    let errorMsg = '';

    table.querySelectorAll('.editable input, .editable select').forEach(input => {
      const name = input.name;
      const value = input.value.trim();

      // üëâ CH·ªà VALIDATE KHI C√ì NH·∫¨P
      if (value !== '') {

        if (name === 'HoTen' && value.length > 50) {
          errorMsg = 'H·ªç t√™n kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 50 k√Ω t·ª±';
        }

        if (name === 'Email' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
          errorMsg = 'Email kh√¥ng h·ª£p l·ªá';
        }

        if (name === 'SDT' && !/^[0-9]{9,11}$/.test(value)) {
          errorMsg = 'S·ªë ƒëi·ªán tho·∫°i ph·∫£i t·ª´ 9‚Äì11 ch·ªØ s·ªë';
        }
      }

      formData[name] = value || null;
    });

    if (errorMsg) {
      alert('‚ö†Ô∏è ' + errorMsg);
      return;
    }

    const res = await fetch(`/admin/user/update/${userId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });

    const result = await res.json();

    if (result.success) {
      alert(' C·∫≠p nh·∫≠t th√†nh c√¥ng');
      location.reload();
    } else {
      alert(' L·ªói: ' + result.message);
    }
  });
</script>

<%- include('./layout/footer') %>
