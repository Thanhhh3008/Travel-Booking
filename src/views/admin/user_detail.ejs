<%- include('./layout/header') %>

<div class="container mt-4">
  <h3>ğŸ“„ Chi tiáº¿t NgÆ°á»i dÃ¹ng</h3>

  <form id="editForm">
    <table class="table table-bordered mt-3" id="userTable">
      <tr><th>MÃ£ ngÆ°á»i dÃ¹ng</th><td><%= user.MaNguoiDung %></td></tr>
      <tr><th>Há» tÃªn</th><td class="editable" data-field="HoTen"><%= user.HoTen %></td></tr>
      <tr><th>NgÃ y sinh</th><td class="editable" data-field="NgaySinh"><%= user.NgaySinh ? new Date(user.NgaySinh).toISOString().split('T')[0] : '' %></td></tr>
      <tr><th>CCCD</th><td class="editable" data-field="CCCD"><%= user.CCCD %></td></tr>
      <tr><th>Username</th><td><%= user.Username %></td></tr>
      <tr><th>Email</th><td class="editable" data-field="Email"><%= user.Email %></td></tr>
      <tr><th>Äá»‹a chá»‰</th><td class="editable" data-field="DiaChi"><%= user.DiaChi %></td></tr>
      <tr><th>SÄT</th><td class="editable" data-field="SDT"><%= user.SDT %></td></tr>
      <tr><th>Quá»‘c tá»‹ch</th><td class="editable" data-field="QuocTich"><%= user.QuocTich %></td></tr>
      <tr><th>ÄÃ¡nh giÃ¡</th><td class="editable" data-field="Rating"><%= user.Rating %></td></tr>
    </table>

    <div class="d-flex justify-content-end gap-2 mt-3">
      <a href="/admin/user" class="btn btn-secondary">â¬…ï¸ Quay láº¡i</a>
      <button type="button" id="editBtn" class="btn btn-warning">âœï¸ Sá»­a</button>
      <button type="button" id="saveBtn" class="btn btn-success d-none">ğŸ’¾ LÆ°u</button>
      <a href="/admin/user/delete/<%= user.MaNguoiDung %>" class="btn btn-danger"
        onclick="return confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a ngÆ°á»i dÃ¹ng nÃ y khÃ´ng?')">ğŸ—‘ï¸ XÃ³a</a>
    </div>
  </form>
</div>

<script>
  const editBtn = document.getElementById('editBtn');
  const saveBtn = document.getElementById('saveBtn');
  const table = document.getElementById('userTable');
  const userId = "<%= user.MaNguoiDung %>";

  editBtn.addEventListener('click', () => {
    table.querySelectorAll('.editable').forEach(td => {
      const value = td.textContent.trim();
      td.innerHTML = `<input type="text" class="form-control" name="${td.dataset.field}" value="${value}">`;
    });
    editBtn.classList.add('d-none');
    saveBtn.classList.remove('d-none');
  });

  saveBtn.addEventListener('click', async () => {
    const formData = {};
    let valid = true;
    let errorMsg = "";

    table.querySelectorAll('.editable input').forEach(input => {
      const name = input.name;
      const value = input.value.trim();

      // âœ… RÃ ng buá»™c Ä‘Æ¡n giáº£n
      if (!value) {
        valid = false;
        errorMsg = "KhÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng cÃ¡c trÆ°á»ng báº¯t buá»™c.";
      } 
      else if (name === "HoTen" && value.length > 50) {
        valid = false;
        errorMsg = "Há» tÃªn khÃ´ng Ä‘Æ°á»£c vÆ°á»£t quÃ¡ 50 kÃ½ tá»±.";
      }
      else if (name === "Email" && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
        valid = false;
        errorMsg = "Email khÃ´ng há»£p lá»‡.";
      }
      else if (name === "SDT" && !/^[0-9]{9,11}$/.test(value)) {
        valid = false;
        errorMsg = "Sá»‘ Ä‘iá»‡n thoáº¡i pháº£i tá»« 9-11 chá»¯ sá»‘.";
      }
      else if (name === "CCCD" && !/^[0-9]{9,12}$/.test(value)) {
        valid = false;
        errorMsg = "CCCD pháº£i lÃ  sá»‘ (9-12 chá»¯ sá»‘).";
      }

      formData[name] = value;
    });

    if (!valid) {
      alert('âš ï¸ ' + errorMsg);
      return;
    }

    const res = await fetch(`/admin/user/update/${userId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });

    const result = await res.json();
    if (result.success) {
      alert('âœ… Cáº­p nháº­t thÃ nh cÃ´ng!');
      window.location.href = `/admin/user/detail/${userId}?updated=1`;
    } else {
      alert('âŒ Lá»—i cáº­p nháº­t: ' + result.message);
    }
  });

  
</script>

<%- include('./layout/footer') %>
