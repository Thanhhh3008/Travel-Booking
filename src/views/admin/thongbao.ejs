<%- include('./layout/header') %>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h3>üì¢ Qu·∫£n l√Ω Th√¥ng b√°o</h3>

    <!-- Thanh t√¨m ki·∫øm v√† l·ªçc -->
    <form action="/admin/thongbao" method="get" class="d-flex align-items-center gap-2 search-bar">
      <input 
        type="text" 
        name="search" 
        class="form-control form-control-sm search-input" 
        placeholder="T√¨m theo ti√™u ƒë·ªÅ..." 
        value="<%= search || '' %>"
      >
   
      <button type="submit" class="btn btn-primary btn-sm">üîç</button>
      <% if (search) { %>
        <a href="/admin/thongbao" class="btn btn-secondary btn-sm">‚ùå</a>
      <% } %>
    </form>
  </div>

  <!-- Form th√™m th√¥ng b√°o -->
   <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addThongBaoModal">
  ‚ûï Th√™m Th√¥ng B√°o
</button>
<!-- Modal Th√™m Th√¥ng B√°o -->
<div class="modal fade" id="addThongBaoModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <!-- Header -->
      <div class="modal-header">
        <h5 class="modal-title">Th√™m Th√¥ng B√°o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <form action="/admin/thongbao/add" method="POST" enctype="multipart/form-data" id="addThongBaoForm">

          <div class="row g-3">

            <!-- Ti√™u ƒë·ªÅ -->
            <div class="col-md-6">
              <label class="form-label">Ti√™u ƒë·ªÅ</label>
              <input type="text" name="TieuDe" class="form-control" placeholder="Ti√™u ƒë·ªÅ" required>
            </div>

            <!-- Lo·∫°i th√¥ng b√°o -->
            <div class="col-md-3">
              <label class="form-label">Lo·∫°i th√¥ng b√°o</label>
              <select name="LoaiThongBao" class="form-select">
                <option value="toan_cuc">T·∫•t c·∫£</option>
                <option value="ca_nhan">C√° nh√¢n</option>
              </select>
            </div>


            <!-- Email ng∆∞·ªùi nh·∫≠n -->
            <div class="col-md-12">
              <label class="form-label">Email ng∆∞·ªùi nh·∫≠n (n·∫øu l√† c√° nh√¢n)</label>
              <input type="text" name="NguoiNhan" class="form-control" placeholder="Email" disabled>
            </div>

            <!-- N·ªôi dung -->
            <div class="col-md-12">
              <label class="form-label">N·ªôi dung th√¥ng b√°o</label>
              <textarea name="NoiDung" rows="4" class="form-control" placeholder="N·ªôi dung th√¥ng b√°o" required></textarea>
            </div>

            <!-- ·∫¢nh ƒë·∫°i di·ªán -->
            <div class="col-md-12">
              <label for="thumbnailAdd" class="form-label">·∫¢nh ƒë·∫°i di·ªán (thumbnail)</label>
              <input type="file" id="thumbnailAdd" name="thumbnail" accept="image/*" class="form-control">
            </div>

          </div>

        </form>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        <button type="submit" form="addThongBaoForm" class="btn btn-primary">Th√™m Th√¥ng B√°o</button>
      </div>

    </div>
  </div>
</div>


  <!-- B·∫£ng danh s√°ch th√¥ng b√°o -->
  <table class="table table-striped mt-4" style="table-layout: fixed; width: 100%; border-collapse: collapse;">
  <thead>
    <tr>
      <th>#</th>
      <th>Ti√™u ƒë·ªÅ</th>
      <th>N·ªôi dung</th>
      <th>Lo·∫°i</th>
      <th>Ng∆∞·ªùi nh·∫≠n</th>
      <th>Thao t√°c</th>
    </tr>
  </thead>

  <tbody>
    <% if (thongbaos && thongbaos.length > 0) { %>
      <% thongbaos.forEach(tb => { %>
        <tr>
          <td><%= tb.MaThongBao %></td>

          <td><%= tb.TieuDe %></td>

          <td class="text-truncate" title="<%= tb.NoiDung %>">
            <%= tb.NoiDung %>
          </td>

          <td>
            <span class="badge <%= tb.LoaiThongBao === 'ca_nhan' ? 'bg-info' : 'bg-secondary' %>">
              <%= tb.LoaiThongBao === 'ca_nhan' ? 'C√° nh√¢n' : 'To√†n c·ª•c' %>
            </span>
          </td>

          <td>
            <%= tb.EmailNguoiNhan || 'T·∫•t c·∫£' %>
          </td>

          <td>
            <!-- Xem chi ti·∫øt -->
            <a href="/admin/thongbao/detail/<%= tb.MaThongBao %>" 
               class="btn btn-info btn-sm" 
               title="Xem chi ti·∫øt">
              <i class="fa-solid fa-eye"></i>
            </a>

            <!-- Ch·ªânh s·ª≠a -->
            <button 
              class="btn btn-warning btn-sm" 
              title="Ch·ªânh s·ª≠a"
              data-bs-toggle="modal" 
              data-bs-target="#editModal"
              onclick="openEditModal(
                '<%= tb.MaThongBao %>',
                '<%= tb.TieuDe %>',
                '<%= tb.NoiDung %>',
                '<%= tb.LoaiThongBao %>',
                '<%= tb.EmailNguoiNhan || '' %>'
              )">
              <i class="fa-solid fa-pen-to-square"></i>
            </button>

            <!-- X√≥a -->
            <a href="/admin/thongbao/delete/<%= tb.MaThongBao %>" 
               class="btn btn-danger btn-sm"
               title="X√≥a"
               onclick="return confirm('X√≥a th√¥ng b√°o n√†y?')">
              <i class="fa-solid fa-trash"></i>
            </a>
          </td>
        </tr>
      <% }) %>
    <% } else { %>
      <tr>
        <td colspan="6" class="text-center text-muted">
          Kh√¥ng c√≥ th√¥ng b√°o n√†o ph√π h·ª£p.
        </td>
      </tr>
    <% } %>
  </tbody>
</table>

</div>

<!-- Modal S·ª≠a -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editForm" method="POST" action="">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">S·ª≠a Th√¥ng B√°o</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="MaThongBao" id="editMaThongBao">
          <div class="mb-2">
            <label>Ti√™u ƒë·ªÅ</label>
            <input type="text" name="TieuDe" id="editTieuDe" class="form-control">
          </div>
          <div class="mb-2">
            <label>Lo·∫°i th√¥ng b√°o</label>
            <select name="LoaiThongBao" id="editLoaiThongBao" class="form-select">
              <option value="toan_cuc">To√†n c·ª•c</option>
              <option value="ca_nhan">C√° nh√¢n</option>
            </select>
          </div>
         
          
          <div class="mb-2">
            <label>Email ng∆∞·ªùi nh·∫≠n (n·∫øu c√° nh√¢n)</label>
            <input type="text" name="NguoiNhan" id="editNguoiNhan" class="form-control" placeholder="Email ng∆∞·ªùi nh·∫≠n">
          </div>

          <div class="mb-2">
            <label>N·ªôi dung</label>
            <textarea name="NoiDung" id="editNoiDung" rows="3" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="submit" class="btn btn-primary">üíæ L∆∞u thay ƒë·ªïi</button>
        </div>
      </div>
    </form>
  </div>
</div>
<script>
  // --- M·ªü modal s·ª≠a ---
  function openEditModal(id, title, content, loai, nguoiNhan) {
    document.getElementById('editMaThongBao').value = id;
    document.getElementById('editTieuDe').value = title;
    document.getElementById('editNoiDung').value = content;
    
    document.getElementById('editLoaiThongBao').value = loai.trim();
console.log(loai);
    document.getElementById('editNguoiNhan').value = nguoiNhan;
    document.getElementById('editForm').action = `/admin/thongbao/edit/${id}`;

    toggleEditFields(); // 
  }

  // --- FORM TH√äM M·ªöI ---
  const formAdd = document.querySelector('form[action="/admin/thongbao/add"]');
  const loaiSelect = formAdd.querySelector('select[name="LoaiThongBao"]');

  const nguoiNhanInput = formAdd.querySelector('input[name="NguoiNhan"]');

  function toggleAddFields() {
    if (loaiSelect.value === 'ca_nhan') {
      //
     
     
      nguoiNhanInput.disabled = false;
      nguoiNhanInput.placeholder = 'Email ng∆∞·ªùi nh·∫≠n';
    } else {
      // 
      
      nguoiNhanInput.value = '';
      nguoiNhanInput.disabled = true;
      nguoiNhanInput.placeholder = '';
    }
  }

  loaiSelect.addEventListener('change', toggleAddFields);
  document.addEventListener('DOMContentLoaded', toggleAddFields);

  // --- MODAL S·ª¨A ---
  const loaiSelectEdit = document.getElementById('editLoaiThongBao');

  const nguoiNhanInputEdit = document.getElementById('editNguoiNhan');

  function toggleEditFields() {
    if (loaiSelectEdit.value === 'ca_nhan') {
     
      
      nguoiNhanInputEdit.disabled = false;
      nguoiNhanInputEdit.placeholder = 'Email ng∆∞·ªùi nh·∫≠n';
    } else {
     
      nguoiNhanInputEdit.value = '';
      nguoiNhanInputEdit.disabled = true;
      nguoiNhanInputEdit.placeholder = '';
    }
  }

  loaiSelectEdit.addEventListener('change', toggleEditFields);

  // R√ÄNG BU·ªòC H·ª¢P L·ªÜ FORM TH√äM

  formAdd.addEventListener('submit', (e) => {
    const title = formAdd.querySelector('input[name="TieuDe"]').value.trim();
    const content = formAdd.querySelector('textarea[name="NoiDung"]').value.trim();
    const email = nguoiNhanInput.value.trim();

    // Kh√¥ng ƒë·ªÉ tr·ªëng
    if (!title || !content) {
      e.preventDefault();
      alert('Ti√™u ƒë·ªÅ v√† n·ªôi dung kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!');
      return;
    }

    // Gi·ªõi h·∫°n k√Ω t·ª±
    if (title.length > 50) {
      e.preventDefault();
      alert('Ti√™u ƒë·ªÅ kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 50 k√Ω t·ª±!');
      return;
    }
    if (content.length > 300) {
      e.preventDefault();
      alert('N·ªôi dung kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 300 k√Ω t·ª±!');
      return;
    }

    // N·∫øu l√† c√° nh√¢n th√¨ ph·∫£i c√≥ email h·ª£p l·ªá
    if (loaiSelect.value === 'ca_nhan') {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email) {
        e.preventDefault();
        alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p email ng∆∞·ªùi nh·∫≠n!');
        return;
      }
      if (!emailRegex.test(email)) {
        e.preventDefault();
        alert('‚ö†Ô∏è Email ng∆∞·ªùi nh·∫≠n kh√¥ng h·ª£p l·ªá!');
        return;
      }
    }
  });

  
  // R√ÄNG BU·ªòC H·ª¢P L·ªÜ FORM S·ª¨A
 
  
  const editForm = document.getElementById('editForm');
  editForm.addEventListener('submit', (e) => {
    const title = document.getElementById('editTieuDe').value.trim();
    const content = document.getElementById('editNoiDung').value.trim();
    const loai = document.getElementById('editLoaiThongBao').value.trim()
    const email = document.getElementById('editNguoiNhan').value.trim();

    if (!title || !content) {
      e.preventDefault();
      alert('‚ö†Ô∏è Ti√™u ƒë·ªÅ v√† n·ªôi dung kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!');
      return;
    }

    if (title.length > 50) {
      e.preventDefault();
      alert('‚ö†Ô∏è Ti√™u ƒë·ªÅ kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 50 k√Ω t·ª±!');
      return;
    }
    if (content.length > 300) {
      e.preventDefault();
      alert('‚ö†Ô∏è N·ªôi dung kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 300 k√Ω t·ª±!');
      return;
    }

    if (loai === 'ca_nhan') {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email) {
        e.preventDefault();
        alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p email ng∆∞·ªùi nh·∫≠n!');
        return;
      }
      if (!emailRegex.test(email)) {
        e.preventDefault();
        alert('‚ö†Ô∏è Email ng∆∞·ªùi nh·∫≠n kh√¥ng h·ª£p l·ªá!');
        return;
      }
    }
  });
</script>


<style>

  .search-bar { max-width: 500px; }
  .search-input { width: 220px; font-size: 14px; }
  .btn-sm { padding: 4px 10px; font-size: 13px; }
  textarea { font-size: 14px; }
  /* Gi·ªõi h·∫°n chi·ªÅu r·ªông c·ªßa c·ªôt n·ªôi dung */


/* ƒê·∫£m b·∫£o c√°c c·ªôt c√≥ width c·ªë ƒë·ªãnh */
table th:nth-child(1), table td:nth-child(1) { width: 50px; } /* # */
table th:nth-child(2), table td:nth-child(2) { width: 150px; } /* Ti√™u ƒë·ªÅ */
table th:nth-child(3), table td:nth-child(3) { width: 360px; } /* N·ªôi dung */
table th:nth-child(4), table td:nth-child(4) { width: 100px; } /* Lo·∫°i */
table th:nth-child(5), table td:nth-child(5) { width: 200px; } /* Ng∆∞·ªùi nh·∫≠n */
table th:nth-child(6), table td:nth-child(6) { width: 120px; } /* Thao t√°c */


</style>
<div class="alert alert-success position-fixed top-0 end-0 m-3 d-none" id="notifyBox" role="alert"></div>

<script>
  const params = new URLSearchParams(window.location.search);

  if (params.get('added') === '1') {
    alert('‚úÖ Th√™m th√¥ng b√°o th√†nh c√¥ng!');
    window.history.replaceState({}, document.title, window.location.pathname);
  } 
  else if (params.get('edited') === '1') {
    alert('‚úèÔ∏è C·∫≠p nh·∫≠t th√¥ng b√°o th√†nh c√¥ng!');
    window.history.replaceState({}, document.title, window.location.pathname);
  } 
  else if (params.get('deleted') === '1') {
    alert('üóëÔ∏è X√≥a th√¥ng b√°o th√†nh c√¥ng!');
    window.history.replaceState({}, document.title, window.location.pathname);
  } 
  else if (params.get('error') === 'notfound') {
    alert('‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng v·ªõi email ƒë√£ nh·∫≠p!');
    window.history.replaceState({}, document.title, window.location.pathname);
  } 
  else if (params.get('error') === 'invalid') {
    alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p email h·ª£p l·ªá cho th√¥ng b√°o c√° nh√¢n!');
    window.history.replaceState({}, document.title, window.location.pathname);
  }

  
</script>



<%- include('./layout/footer') %>
