<%- include('./layout/header') %>

<div class="header-card">
  <h4>üåô Xin ch√†o, Admin Th√†nh Nguy·ªÖn!</h4>
  <p>Ch√†o m·ª´ng tr·ªü l·∫°i v·ªõi b·∫£ng ƒëi·ªÅu khi·ªÉn qu·∫£n l√Ω h·ªá th·ªëng.</p>
  <small>C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <%= new Date().toLocaleString("vi-VN") %></small>
</div>

<!-- Cards -->
<div class="row g-3">
  <div class="col-md-3">
    <div class="card card-light-blue">
      <div class="card-body">
        <h6>Ng∆∞·ªùi d√πng</h6>
        <h3><%= stats.users %></h3>
        <p class="text-success">+8%</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card card-light-green">
      <div class="card-body">
        <h6>S·ªë ph√≤ng</h6>
        <h3><%= stats.rooms %></h3>
        <p class="text-success">ƒêang ho·∫°t ƒë·ªông</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card card-light-yellow">
      <div class="card-body">
        <h6>ƒê·∫∑t ph√≤ng h√¥m nay</h6>
        <h3><%= stats.bookingsToday %></h3>
        <p class="text-danger">-2%</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card card-light-pink">
      <div class="card-body">
        <h6>Doanh thu</h6>
        <h3><%= stats.revenue %>M</h3>
        <p class="text-success">+5%</p>
      </div>
    </div>
  </div>
</div>

<!-- Chart -->
<div class="card mt-4 shadow-sm border-0">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">üìà Bi·ªÉu ƒë·ªì doanh thu & ƒë·∫∑t ph√≤ng</h5>
      <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-outline-secondary active" data-period="7">7 ng√†y</button>
        <button type="button" class="btn btn-outline-secondary" data-period="30">30 ng√†y</button>
        <button type="button" class="btn btn-outline-secondary" data-period="90">3 th√°ng</button>
        <button type="button" class="btn btn-outline-secondary" data-period="365">1 nƒÉm</button>
      </div>
    </div>
    <canvas id="dashboardChart" height="100"></canvas>
  </div>
</div>

<!-- B·∫£ng ng∆∞·ªùi d√πng nh·ªè g·ªçn -->
<div class="card mt-4 shadow-sm border-0">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">
        <i class="fa-solid fa-users text-primary me-2"></i>
        Ng∆∞·ªùi d√πng g·∫ßn ƒë√¢y
      </h5>
      <div class="d-flex gap-2">
        <div class="btn-group btn-group-sm">
          <button class="btn btn-outline-secondary active" data-time="week">Tu·∫ßn n√†y</button>
          <button class="btn btn-outline-secondary" data-time="month">Th√°ng n√†y</button>
        </div>
        <a href="/admin/user" class="btn btn-sm btn-primary">
          Xem t·∫•t c·∫£
        </a>
       
      </div>
    </div>
    
    <div class="table-responsive">
      <table class="table table-hover align-middle compact-table">
        <thead class="table-light">
          <tr>
            <th style="width: 60px;">#</th>
            <th style="width: 120px;">Tr·∫°ng th√°i</th>
            <th>T√™n</th>
            <th style="width: 180px;">Ho·∫°t ƒë·ªông</th>
            
            <th style="width: 80px;" class="text-center"></th>
          </tr>
        </thead>
        <tbody>
          <% if (recentUsers && recentUsers.length > 0) { %>
            <% recentUsers.forEach((user, index) => { 
              // Generate random activity data for demo
              const activityPercent = Math.floor(Math.random() * 100);
              const activityColor = activityPercent > 60 ? 'success' : activityPercent > 40 ? 'warning' : 'danger';
            %>
            <tr>
              <td class="text-muted fw-semibold">#<%= user.MaNguoiDung %></td>
              <td>
                <% if (user.status === 1 || user.status === '1') { %>
                  <span class="badge bg-success">Ho√†n th√†nh</span>
                <% } else if (user.status === 0 || user.status === '0') { %>
                  <span class="badge bg-warning text-dark">Ch·ªù duy·ªát</span>
                <% } else if (user.status === 2) { %>
                  <span class="badge bg-info">ƒêang x·ª≠ l√Ω</span>
                <% } else { %>
                  <span class="badge bg-secondary">T·∫°m ng∆∞ng</span>
                <% } %>
              </td>
              <td>
                <div class="d-flex align-items-center">
                  <% if (user.avartar) { %>
                    <img 
                      src="/avartar/<%= user.avartar %>" 
                      alt="<%= user.HoTen %>" 
                      class="user-avatar-sm me-2"
                      onerror="this.src='https://ui-avatars.com/api/?name=<%= encodeURIComponent(user.HoTen) %>&background=random&size=32'"
                    >
                  <% } else { %>
                    <img 
                      src="https://ui-avatars.com/api/?name=<%= encodeURIComponent(user.HoTen) %>&background=random&size=32" 
                      alt="<%= user.HoTen %>" 
                      class="user-avatar-sm me-2"
                    >
                  <% } %>
                  <div>
                    <div class="fw-semibold small"><%= user.HoTen %></div>
                    <small class="text-muted"><%= user.vaiTro || 'Kh√°ch h√†ng' %></small>
                  </div>
                </div>
              </td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="progress flex-grow-1 me-2" style="height: 6px;">
                    <div class="progress-bar bg-<%= activityColor %>" style="width: <%= activityPercent %>%"></div>
                  </div>
                  <small class="text-muted"><%= activityPercent %>%</small>
                </div>
              </td>
              <td>
                <div class="mini-chart">
                  <canvas id="salesChart<%= index %>" height="30"></canvas>
                </div>
              </td>
              <td class="text-center">
                <button class="btn btn-sm btn-light" title="C√†i ƒë·∫∑t">
                  <i class="fa-solid fa-ellipsis-vertical"></i>
                </button>
              </td>
            </tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="6" class="text-center py-4 text-muted">
                <i class="fa-solid fa-inbox fa-2x mb-2"></i>
                <p class="mb-0">Ch∆∞a c√≥ d·ªØ li·ªáu ng∆∞·ªùi d√πng</p>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
    
   
  </div>
</div>

<!-- C√°c quy tr√¨nh qu·∫£n l√Ω -->
<div class="row g-3 mt-4">
  <div class="col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h5>
          <i class="fa-solid fa-file-circle-check text-primary me-2"></i>
          Quy tr√¨nh ph√™ duy·ªát ch·ªó ·ªü m·ªõi
        </h5>
        <p>
          Admin ki·ªÉm tra h·ªì s∆°, h√¨nh ·∫£nh, gi·∫•y t·ªù v√† ch·ªçn
          <strong>Ch·∫•p thu·∫≠n</strong> ho·∫∑c <strong>T·ª´ ch·ªëi</strong>.
        </p>
        <a href="/admin/duyetphong/" class="btn btn-primary btn-sm">
          <i class="fa-solid fa-list-check me-1"></i>
          Xem danh s√°ch ch·ªù duy·ªát
        </a>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h5>
          <i class="fa-solid fa-user-gear text-secondary me-2"></i>
          Quy tr√¨nh ph√¢n quy·ªÅn ng∆∞·ªùi d√πng
        </h5>
        <p>
          Admin ch·ªçn t√†i kho·∫£n v√† g√°n quy·ªÅn ph√π h·ª£p trong m·ª•c
          <strong>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</strong>.
        </p>
        <a href="/admin/user" class="btn btn-secondary btn-sm">
          <i class="fa-solid fa-users-gear me-1"></i>
          Qu·∫£n l√Ω ng∆∞·ªùi d√πng
        </a>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-3">
  <div class="col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h5>
          <i class="fa-solid fa-house-circle-check text-warning me-2"></i>
          Qu·∫£n l√Ω ch·ªó ·ªü
        </h5>
        <p>
          Admin theo d√µi v√† qu·∫£n l√Ω to√†n b·ªô danh s√°ch ch·ªó ·ªü trong h·ªá th·ªëng.
        </p>
        <a href="/admin/duyetphong/tatca" class="btn btn-warning btn-sm">
          <i class="fa-solid fa-house me-1"></i>
          Xem danh s√°ch ch·ªó ·ªü
        </a>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h5>
          <i class="fa-solid fa-bullhorn text-info me-2"></i>
          Qu·∫£n l√Ω th√¥ng b√°o h·ªá th·ªëng
        </h5>
        <p>
          T·∫°o, g·ª≠i v√† theo d√µi th√¥ng b√°o ƒë·∫øn ng∆∞·ªùi d√πng ho·∫∑c nh√† cung c·∫•p.
        </p>
        <a href="/admin/thongbao" class="btn btn-info btn-sm text-white">
          <i class="fa-solid fa-plus me-1"></i>
          T·∫°o th√¥ng b√°o m·ªõi
        </a>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-3">
  <div class="col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h5>
          <i class="fa-solid fa-calendar-check text-success me-2"></i>
          Theo d√µi ƒë∆°n ƒë·∫∑t ph√≤ng
        </h5>
        <p>
          Qu·∫£n l√Ω, theo d√µi v√† x·ª≠ l√Ω t·∫•t c·∫£ ƒë∆°n ƒë·∫∑t ph√≤ng trong h·ªá th·ªëng.
        </p>
        <a href="/admin/datphong" class="btn btn-success btn-sm">
          <i class="fa-solid fa-calendar-days me-1"></i>
          Xem danh s√°ch ƒë∆°n ƒë·∫∑t ph√≤ng
        </a>
      </div>
    </div>
  </div>
</div>

<style>
/* Compact table styling */
.compact-table {
  font-size: 0.875rem;
}

.compact-table thead th {
  font-weight: 600;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #6c757d;
  border-bottom: 2px solid #dee2e6;
  padding: 0.75rem 0.5rem;
}

.compact-table tbody td {
  padding: 0.65rem 0.5rem;
  vertical-align: middle;
}

.user-avatar-sm {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #f8f9fa;
}

.badge {
  font-size: 0.7rem;
  padding: 0.35rem 0.65rem;
  font-weight: 500;
}

.progress {
  background-color: #e9ecef;
}

.mini-chart {
  height: 30px;
}

/* Hover effect */
.compact-table tbody tr {
  transition: all 0.2s ease;
}

.compact-table tbody tr:hover {
  background-color: rgba(0, 123, 255, 0.03);
  box-shadow: inset 3px 0 0 0 #007bff;
}

/* Button group styling */
.btn-group-sm .btn {
  font-size: 0.75rem;
  padding: 0.35rem 0.75rem;
}

.btn-group .btn.active {
  background-color: #343a40;
  border-color: #343a40;
  color: white;
}

/* Chart period buttons */
.btn-group[role="group"] .btn {
  border-color: #dee2e6;
}

.btn-group[role="group"] .btn.active {
  background-color: #212529;
  border-color: #212529;
  color: white;
}

/* Responsive */
@media (max-width: 768px) {
  .compact-table {
    font-size: 0.75rem;
  }
  
  .user-avatar-sm {
    width: 28px;
    height: 28px;
  }
  
  .badge {
    font-size: 0.65rem;
    padding: 0.25rem 0.5rem;
  }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ==========================================
  // PH·∫¶N 1: BI·ªÇU ƒê·ªí CH√çNH (MAIN CHART)
  // ==========================================
  const mainChartData = {
    '7': {
      labels: ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'],
      revenue: [45, 52, 48, 65, 58, 72, 68],
      bookings: [12, 15, 13, 18, 16, 21, 19]
    },
    '30': {
      labels: ['Tu·∫ßn 1', 'Tu·∫ßn 2', 'Tu·∫ßn 3', 'Tu·∫ßn 4'],
      revenue: [180, 220, 195, 245],
      bookings: [48, 62, 51, 73]
    },
    '90': {
      labels: ['Th√°ng 1', 'Th√°ng 2', 'Th√°ng 3'],
      revenue: [620, 780, 850],
      bookings: [165, 208, 227]
    },
    '365': {
      labels: ['Q1', 'Q2', 'Q3', 'Q4'],
      revenue: [2250, 2680, 2920, 3150],
      bookings: [600, 715, 780, 842]
    }
  };

  const mainCtx = document.getElementById('dashboardChart');
  let mainChart = null;

  function renderMainChart(period) {
    const data = mainChartData[period];
    if (!data) return;

    if (mainChart) {
      mainChart.data.labels = data.labels;
      mainChart.data.datasets[0].data = data.revenue;
      mainChart.data.datasets[1].data = data.bookings;
      mainChart.update();
    } else {
      mainChart = new Chart(mainCtx, {
        type: 'line',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Doanh thu (tri·ªáu)',
            data: data.revenue,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.4,
            fill: true
          }, {
            label: 'ƒê·∫∑t ph√≤ng',
            data: data.bookings,
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { position: 'top' },
            tooltip: { mode: 'index', intersect: false }
          },
          interaction: { mode: 'nearest', axis: 'x', intersect: false },
          scales: { y: { beginAtZero: true } }
        }
      });
    }
  }

  // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì ch√≠nh m·∫∑c ƒë·ªãnh 7 ng√†y
  renderMainChart('7');

  // S·ª± ki·ªán click cho bi·ªÉu ƒë·ªì ch√≠nh
  const mainFilterButtons = document.querySelectorAll('[data-period]');
  mainFilterButtons.forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      mainFilterButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      renderMainChart(this.getAttribute('data-period'));
    });
  });

  // ==========================================
  // PH·∫¶N 2: MINI CHARTS (B·∫¢NG NG∆Ø·ªúI D√ôNG)
  // ==========================================
  
  // M·∫£ng l∆∞u tr·ªØ t·∫•t c·∫£ c√°c instances c·ªßa bi·ªÉu ƒë·ªì nh·ªè
  const miniChartInstances = [];

  // H√†m t·∫°o d·ªØ li·ªáu ng·∫´u nhi√™n (Gi·∫£ l·∫≠p d·ªØ li·ªáu t·ª´ server)
  function generateRandomData(points) {
    return Array.from({length: points}, () => Math.floor(Math.random() * 100));
  }

  // Kh·ªüi t·∫°o c√°c bi·ªÉu ƒë·ªì nh·ªè ban ƒë·∫ßu
  <% if (recentUsers && recentUsers.length > 0) { %>
    <% recentUsers.forEach((user, index) => { %>
      (function() {
        const miniCtx = document.getElementById('salesChart<%= index %>');
        if (miniCtx) {
          // M·∫∑c ƒë·ªãnh ban ƒë·∫ßu l√† tu·∫ßn (7 ƒëi·ªÉm d·ªØ li·ªáu)
          const initialData = generateRandomData(7); 
          
          const chartInstance = new Chart(miniCtx, {
            type: 'line',
            data: {
              labels: ['', '', '', '', '', '', ''], // Nh√£n r·ªóng ƒë·ªÉ ·∫©n tr·ª•c X
              datasets: [{
                data: initialData,
                borderColor: '<%= ["#4bc0c0", "#9966ff", "#ff9f40", "#4dc9f6"][index % 4] %>',
                borderWidth: 2,
                pointRadius: 0, // ·∫®n ƒëi·ªÉm tr√≤n ƒë·ªÉ chart g·ªçn
                tension: 0.4,
                fill: false
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false }, tooltip: { enabled: false } },
              scales: { x: { display: false }, y: { display: false } },
              animation: { duration: 1000 } // Hi·ªáu ·ª©ng m∆∞·ª£t
            }
          });
          
          // L∆∞u instance v√†o m·∫£ng ƒë·ªÉ d√πng l·∫°i sau n√†y
          miniChartInstances.push(chartInstance);
        }
      })();
    <% }); %>
  <% } %>

  // H√†m c·∫≠p nh·∫≠t to√†n b·ªô Mini Charts
  function updateMiniCharts(timeFrame) {
    // X√°c ƒë·ªãnh s·ªë ƒëi·ªÉm d·ªØ li·ªáu: Tu·∫ßn = 7, Th√°ng = 15 (ƒë·ªÉ ƒë∆∞·ªùng v·∫Ω d√†i h∆°n/kh√°c ƒëi)
    const dataPoints = timeFrame === 'week' ? 7 : 15; 
    const labels = new Array(dataPoints).fill('');

    miniChartInstances.forEach(chart => {
      // T·∫°o d·ªØ li·ªáu m·ªõi ng·∫´u nhi√™n cho t·ª´ng bi·ªÉu ƒë·ªì
      const newData = generateRandomData(dataPoints);
      
      // C·∫≠p nh·∫≠t d·ªØ li·ªáu v√† nh√£n
      chart.data.labels = labels;
      chart.data.datasets[0].data = newData;
      
      // V·∫Ω l·∫°i bi·ªÉu ƒë·ªì
      chart.update();
    });
  }

  // S·ª± ki·ªán click cho b·ªô l·ªçc Mini Charts (Tu·∫ßn n√†y / Th√°ng n√†y)
  const userFilterButtons = document.querySelectorAll('[data-time]');
  userFilterButtons.forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      
      // X·ª≠ l√Ω CSS active
      userFilterButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      // L·∫•y lo·∫°i th·ªùi gian (week/month) v√† g·ªçi h√†m c·∫≠p nh·∫≠t
      const timeFrame = this.getAttribute('data-time');
      console.log('C·∫≠p nh·∫≠t mini charts theo:', timeFrame);
      updateMiniCharts(timeFrame);
    });
  });

});
</script>


<%- include('./layout/footer') %>