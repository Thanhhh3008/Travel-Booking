<%- include('../layout/header.ejs') %>

<link rel="stylesheet"href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="/manage-booking.css">
<main class="container" style="padding: 24px 0;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <h2 style="margin:0; font-weight:900;">
            <i class="fas fa-receipt"></i>
            Qu·∫£n l√Ω ƒë∆°n ƒë·∫∑t ph√≤ng
        </h2>

        <a href="/rooms/my-rooms" style="text-decoration:none; font-weight:800;">
            <i class="fas fa-building"></i> Qu·∫£n l√Ω ph√≤ng c·ªßa t√¥i
        </a>
    </div>

 <!-- Th√¥ng b√°o flash -->
<% if (message) { %>
<div class="alert <%= message.type %>">
  <span class="alert-icon">
    <%= message.type === 'success' ? '‚úÖ' : '‚ö†Ô∏è' %>
  </span>
  <span class="alert-text"><%= message.mess %></span>
  <button class="alert-close" onclick="this.parentElement.style.display='none';">&times;</button>
</div>
<% } %>

    <% 
    // Ph√¢n lo·∫°i ƒë∆°n theo TrangThai
    const completedBookings = bookings ? bookings.filter(b => b.TrangThai === 'ƒê√£ ho√†n th√†nh') : [];
    const pendingBookings = bookings ? bookings.filter(b => b.TrangThai !== 'ƒê√£ ho√†n th√†nh') : [];
    
    // T√≠nh th·ªëng k√™
    const totalBookings = bookings ? bookings.length : 0;
    const totalRevenue = bookings ? bookings.reduce((sum, b) => sum + (parseFloat(b.TongTien) || 0), 0) : 0;
    const completedRevenue = completedBookings.reduce((sum, b) => sum + (parseFloat(b.TongTien) || 0), 0);
    const pendingRevenue = pendingBookings.reduce((sum, b) => sum + (parseFloat(b.TongTien) || 0), 0);
    
    // Th·ªëng k√™ theo tr·∫°ng th√°i
    const statusCounts = {};
    if (bookings) {
        bookings.forEach(b => {
            const status = (b.LichSu || 'BOOKED').toUpperCase().trim();
            statusCounts[status] = (statusCounts[status] || 0) + 1;
        });
    }
    %>

    <!-- Th·ªëng k√™ t·ªïng quan -->
    <div class="stats-container">
        <div class="stat-card primary">
            <div class="stat-icon">
                <i class="fas fa-receipt"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value"><%= totalBookings %></div>
                <div class="stat-label">T·ªïng ƒë∆°n</div>
            </div>
        </div>

        <div class="stat-card success">
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value"><%= completedBookings.length %></div>
                <div class="stat-label">ƒê√£ ho√†n th√†nh</div>
            </div>
        </div>

        <div class="stat-card warning">
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value"><%= pendingBookings.length %></div>
                <div class="stat-label">Ch∆∞a ho√†n th√†nh</div>
            </div>
        </div>

        <div class="stat-card revenue">
            <div class="stat-icon">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value"><%= helpers.formatMoney(totalRevenue) %>ƒë</div>
                <div class="stat-label">T·ªïng doanh thu d·ª± ki·∫øn</div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab('pending')">
            <i class="fas fa-clock"></i>
            Ch∆∞a ho√†n th√†nh (<%= pendingBookings.length %>)
        </button>
        <button class="tab-btn" onclick="switchTab('completed')">
            <i class="fas fa-check-circle"></i>
            ƒê√£ ho√†n th√†nh (<%= completedBookings.length %>)
        </button>
    </div>

    <!-- Tab Content: Ch∆∞a ho√†n th√†nh -->
    <div id="tab-pending" class="tab-content active">
        <div class="tab-stats">
            <div class="mini-stat">
                <i class="fas fa-dollar-sign"></i>
                <span>Doanh thu: <b><%= helpers.formatMoney(pendingRevenue) %>ƒë</b></span>
            </div>
            
           
        </div>

        <% if (pendingBookings.length === 0) { %>
        <div class="empty-state">
            <div style="font-size:40px; margin-bottom:8px;">üì≠</div>
            <div style="font-weight:900;">Kh√¥ng c√≥ ƒë∆°n ch∆∞a ho√†n th√†nh</div>
            <div style="opacity:.75; margin-top:6px;">T·∫•t c·∫£ ƒë∆°n ƒë·∫∑t ph√≤ng ƒë√£ ƒë∆∞·ª£c ho√†n th√†nh.</div>
        </div>
        <% } else { %>
        <div class="booking-grid">
            <% pendingBookings.forEach((b) => { %>
            <% const img = b.HinhAnh ? b.HinhAnh.split(',')[0].trim() : 'default.jpg'; %>
            <% const life = (b.LichSu || 'BOOKED').toUpperCase().trim(); %>

            <div class="booking-card">
                <div class="booking-head">
                    <div class="left">
                        <div class="badge-id">
                            <i class="fas fa-receipt"></i>
                            ƒê∆°n #<%= b.MaChiTietDatPhong %>
                        </div>
                        <div class="badge-life <%= helpers.lifeClass(b.LichSu) %>">
                            <i class="fas fa-info-circle"></i>
                            <%= helpers.mapLife(b.LichSu) %>
                        </div>
                    </div>

                    <a class="btn-view-room" href="/rooms/<%= b.MaPhong %>">
                        <i class="fas fa-eye"></i> Xem ph√≤ng
                    </a>
                </div>

                <div class="booking-body">
                    <div class="room-mini">
                        <img src="/admin/uploads/anhphong/<%= img %>"
                            onerror="this.src='/images/default-room.jpg'"
                            alt="room">
                        <div>
                            <div style="font-weight:900; font-size:15px;">
                                <%= b.TenLoaiPhong || 'Ph√≤ng' %> - S·ªë <%= b.SoPhong || b.MaPhong %>
                            </div>
                            <div style="opacity:.75; font-weight:700; margin-top:2px;">
                                Ng∆∞·ªùi ƒë·∫∑t: <b><%= b.Username || '---' %></b>
                            </div>
                        </div>
                    </div>

                    <div class="rows">
                        <div class="row">
                            <i class="fas fa-calendar-plus"></i>
                            Nh·∫≠n: <b><%= helpers.formatDate(b.NgayNhanPhong) %></b>
                        </div>
                        <div class="row">
                            <i class="fas fa-calendar-minus"></i>
                            Tr·∫£: <b><%= helpers.formatDate(b.NgayTraPhong) %></b>
                        </div>
                        <div class="row">
                            <i class="fas fa-users"></i>
                            Kh√°ch: <b><%= b.SoLuongKhach || 1 %></b>
                        </div>
                        <div class="row total">
                            <i class="fas fa-money-bill-wave"></i>
                            T·ªïng ti·ªÅn: <b><%= helpers.formatMoney(b.TongTien) %>ƒë</b>
                        </div>
                    </div>

                    <div class="actions">
                        <% if (life === 'BOOKED' || life === 'RESET') { %>
                        <button class="btn btn-checkin"
                            onclick="confirmCheckIn(<%= b.MaChiTietDatPhong %>)">
                            <i class="fas fa-sign-in-alt"></i> Check-in
                        </button>
                        <% } %>

                        <% if (life === 'CHECKED_IN') { %>
                        <button class="btn btn-checkout"
                            onclick="confirmCheckOut(<%= b.MaChiTietDatPhong %>)">
                            <i class="fas fa-sign-out-alt"></i> Check-out
                        </button>
                        <% } %>

                        
                    </div>
                </div>
            </div>
            <% }) %>
        </div>
        <% } %>
    </div>

    <!-- Tab Content: ƒê√£ ho√†n th√†nh -->
    <div id="tab-completed" class="tab-content">
        <div class="tab-stats">
            <div class="mini-stat">
                <i class="fas fa-dollar-sign"></i>
                <span>Doanh thu: <b><%= helpers.formatMoney(completedRevenue) %>ƒë</b></span>
            </div>
            <div class="mini-stat">
                <i class="fas fa-percentage"></i>
                <span>T·ª∑ l·ªá: <b><%= totalBookings > 0 ? Math.round(completedBookings.length / totalBookings * 100) : 0 %>%</b></span>
            </div>
        </div>

        <% if (completedBookings.length === 0) { %>
        <div class="empty-state">
            <div style="font-size:40px; margin-bottom:8px;">üìã</div>
            <div style="font-weight:900;">Ch∆∞a c√≥ ƒë∆°n ho√†n th√†nh</div>
            <div style="opacity:.75; margin-top:6px;">C√°c ƒë∆°n ƒë√£ ho√†n th√†nh s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</div>
        </div>
        <% } else { %>
        <div class="booking-grid">
            <% completedBookings.forEach((b) => { %>
            <% const img = b.HinhAnh ? b.HinhAnh.split(',')[0].trim() : 'default.jpg'; %>
            <% const life = (b.LichSu || 'BOOKED').toUpperCase().trim(); %>

            <div class="booking-card">
                <div class="booking-head">
                    <div class="left">
                        <div class="badge-id">
                            <i class="fas fa-receipt"></i>
                            ƒê∆°n #<%= b.MaChiTietDatPhong %>
                        </div>
                       
                    </div>

                    <a class="btn-view-room" href="/rooms/<%= b.MaPhong %>">
                        <i class="fas fa-eye"></i> Xem ph√≤ng
                    </a>
                </div>

                <div class="booking-body">
                    <div class="room-mini">
                        <img src="/admin/uploads/anhphong/<%= img %>"
                            onerror="this.src='/images/default-room.jpg'"
                            alt="room">
                        <div>
                            <div style="font-weight:900; font-size:15px;">
                                <%= b.TenLoaiPhong || 'Ph√≤ng' %> - S·ªë <%= b.SoPhong || b.MaPhong %>
                            </div>
                            <div style="opacity:.75; font-weight:700; margin-top:2px;">
                                Ng∆∞·ªùi ƒë·∫∑t: <b><%= b.Username || '---' %></b>
                            </div>
                        </div>
                    </div>

                    <div class="rows">
                        <div class="row">
                            <i class="fas fa-calendar-plus"></i>
                            Nh·∫≠n: <b><%= helpers.formatDate(b.NgayNhanPhong) %></b>
                        </div>
                        <div class="row">
                            <i class="fas fa-calendar-minus"></i>
                            Tr·∫£: <b><%= helpers.formatDate(b.NgayTraPhong) %></b>
                        </div>
                        <div class="row">
                            <i class="fas fa-users"></i>
                            Kh√°ch: <b><%= b.SoLuongKhach || 1 %></b>
                        </div>
                        <div class="row total">
                            <i class="fas fa-money-bill-wave"></i>
                            T·ªïng ti·ªÅn: <b><%= helpers.formatMoney(b.TongTien) %>ƒë</b>
                        </div>
                    </div>

                    <div class="completion-badge">
                        <i class="fas fa-check-double"></i>
                        ƒê√£ ho√†n th√†nh
                    </div>
                </div>
            </div>
            <% }) %>
        </div>
        <% } %>
    </div>
</main>


<script>
  function switchTab(tabName) {
    // Remove active class from all tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });

    // Add active class to selected tab
    event.target.classList.add('active');
    document.getElementById('tab-' + tabName).classList.add('active');
  }

  function postTo(url) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = url;
    document.body.appendChild(form);
    form.submit();
  }

  function confirmCheckIn(bookingId) {
    if (confirm(`X√°c nh·∫≠n CHECK-IN cho ƒë∆°n #${bookingId}?`)) {
      postTo(`/owner/bookings/${bookingId}/checkin`);
    }
  }

  function confirmCheckOut(bookingId) {
    if (confirm(`X√°c nh·∫≠n CHECK-OUT cho ƒë∆°n #${bookingId}?`)) {
      postTo(`/owner/bookings/${bookingId}/checkout`);
    }
  }

  function confirmReset(bookingId) {
    if (confirm(`Ho√†n th√†nh k·ª≥ cho ƒë∆°n #${bookingId}?`)) {
      postTo(`/owner/bookings/${bookingId}/reset-room`);
    }
  }
</script>

<%- include('../layout/footer.ejs') %>