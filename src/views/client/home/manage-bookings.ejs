<%- include('../layout/header.ejs') %>

<link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<main class="container" style="padding: 24px 0;">
    <div
        style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <h2 style="margin:0; font-weight:900;">
            <i class="fas fa-receipt"></i>
            Qu·∫£n l√Ω ƒë∆°n ƒë·∫∑t ph√≤ng
        </h2>

        <a href="/rooms/my-rooms"
            style="text-decoration:none; font-weight:800;">
            <i class="fas fa-building"></i> Qu·∫£n l√Ω ph√≤ng c·ªßa t√¥i
        </a>
    </div>

  <% if (typeof message !== 'undefined' && message) { %>
    <div class="alert <%= message.type %>">
        <span class="alert-icon">
            <%= message.type === 'success' ? '‚úÖ' : '‚ö†Ô∏è' %>
        </span>
        <span><%= message.mess %></span>
    </div>
    <% } %>
    <% if (!bookings || bookings.length === 0) { %>
    <div
        style="margin-top:22px; padding:18px; border:1px dashed #ddd; border-radius:14px; text-align:center;">
        <div style="font-size:40px; margin-bottom:8px;">üì≠</div>
        <div style="font-weight:900;">Ch∆∞a c√≥ ƒë∆°n ƒë·∫∑t n√†o</div>
        <div style="opacity:.75; margin-top:6px;">Khi c√≥ kh√°ch ƒë·∫∑t ph√≤ng, ƒë∆°n s·∫Ω
            hi·ªÉn th·ªã ·ªü ƒë√¢y.</div>
    </div>
    <% } else { %>

    <div class="booking-grid">
        <% bookings.forEach((b) => { %>
        <% const img = b.HinhAnh ? b.HinhAnh.split(',')[0].trim() :
        'default.jpg'; %>
        <% const life = (b.LichSu || 'BOOKED').toUpperCase().trim(); %>

        <div class="booking-card">
            <div class="booking-head">
                <div class="left">
                    <div class="badge-id">
                        <i class="fas fa-receipt"></i>
                        ƒê∆°n #<%= b.MaChiTietDatPhong %>
                    </div>
                    <div class="badge-life <%= helpers.lifeClass(b.LichSu) %>">
                        <i class="fas fa-info-circle"></i>
                        <%= helpers.mapLife(b.LichSu) %>
                    </div>
                </div>

                <a class="btn-view-room" href="/rooms/<%= b.MaPhong %>">
                    <i class="fas fa-eye"></i> Xem ph√≤ng
                </a>
            </div>

            <div class="booking-body">
                <div class="room-mini">
                    <img src="/admin/uploads/anhphong/<%= img %>"
                        onerror="this.src='/images/default-room.jpg'"
                        alt="room">
                    <div>
                        <div style="font-weight:900; font-size:15px;">
                            <%= b.TenLoaiPhong || 'Ph√≤ng' %> - S·ªë <%= b.SoPhong
                            || b.MaPhong %>
                        </div>
                        <div
                            style="opacity:.75; font-weight:700; margin-top:2px;">
                            Ng∆∞·ªùi ƒë·∫∑t: <b><%= b.Username || '---'
                                %></b>
                        </div>
                    </div>
                </div>

                <div class="rows">
                    <div class="row">
                        <i class="fas fa-calendar-plus"></i>
                        Nh·∫≠n: <b><%= helpers.formatDate(b.NgayNhanPhong) %></b>
                    </div>
                    <div class="row">
                        <i class="fas fa-calendar-minus"></i>
                        Tr·∫£: <b><%= helpers.formatDate(b.NgayTraPhong) %></b>
                    </div>
                    <div class="row">
                        <i class="fas fa-users"></i>
                        Kh√°ch: <b><%= b.SoLuongKhach || 1 %></b>
                    </div>
                    <div class="row total">
                        <i class="fas fa-money-bill-wave"></i>
                        T·ªïng ti·ªÅn: <b><%= helpers.formatMoney(b.TongTien)
                            %>ƒë</b>
                    </div>
                </div>

                <div class="actions">
                    <% if (life === 'BOOKED' || life === 'RESET') { %>
                    <button class="btn btn-checkin"
                        onclick="confirmCheckIn(<%= b.MaChiTietDatPhong %>)">
                        <i class="fas fa-sign-in-alt"></i> Check-in
                    </button>
                    <% } %>

                    <% if (life === 'CHECKED_IN') { %>
                    <button class="btn btn-checkout"
                        onclick="confirmCheckOut(<%= b.MaChiTietDatPhong %>)">
                        <i class="fas fa-sign-out-alt"></i> Check-out
                    </button>
                    <% } %>

                    <% if (life === 'CHECKED_OUT') { %>
                    <button class="btn btn-reset"
                        onclick="confirmReset(<%= b.MaChiTietDatPhong %>)">
                        <i class="fas fa-redo"></i> Cho ƒë·∫∑t ti·∫øp
                    </button>
                    <% } %>
                </div>
            </div>
        </div>
        <% }) %>
    </div>

    <% } %>
</main>

<style>
  .booking-grid{
    margin-top:18px;
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 14px;
  }
  .booking-card{
    border:1px solid #eee;
    border-radius:16px;
    background:#fff;
    box-shadow: 0 10px 24px rgba(0,0,0,.06);
    overflow:hidden;
  }
  .booking-head{
    padding:12px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    border-bottom:1px solid #f1f1f1;
  }
  .booking-head .left{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .badge-id{
    display:inline-flex; align-items:center; gap:8px;
    font-weight:900;
    padding:7px 10px;
    border-radius:999px;
    background: rgba(102,126,234,.12);
    color:#3b4cca;
    font-size:12px;
  }
  .badge-life{
    display:inline-flex; align-items:center; gap:8px;
    font-weight:900;
    padding:7px 10px;
    border-radius:999px;
    font-size:12px;
    border:1px solid #eee;
  }
  .badge-life.booked{ background: rgba(0,0,0,.04); }
  .badge-life.checkedin{ background: rgba(102,126,234,.12); color:#3b4cca; }
  .badge-life.checkedout{ background: rgba(245,87,108,.12); color:#c21f35; }
  .badge-life.reset{ background: rgba(0,200,83,.12); color:#0d7a37; }
  .badge-life.cancelled{ background: rgba(244,67,54,.12); color:#b71c1c; }

  .btn-view-room{
    text-decoration:none;
    font-weight:900;
    border:1px solid #eee;
    border-radius:12px;
    padding:8px 10px;
    display:inline-flex; align-items:center; gap:8px;
    background:#fafafa;
  }

  .booking-body{ padding:12px 12px 14px; }
  .room-mini{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .room-mini img{
    width:54px; height:54px;
    border-radius:12px;
    object-fit:cover;
    border:1px solid #eee;
  }

  .rows{ margin-top:12px; }
  .row{
    display:flex;
    align-items:center;
    gap:10px;
    margin:6px 0;
    font-weight:700;
  }
  .row i{ width:18px; opacity:.9; }
  .row.total{
    margin-top:10px;
    padding-top:10px;
    border-top:1px dashed #eee;
    font-weight:900;
  }

  .actions{
    margin-top:12px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .btn{
    border:none;
    border-radius:12px;
    padding:10px 12px;
    font-weight:900;
    cursor:pointer;
    display:inline-flex; align-items:center; gap:8px;
  }
  .btn-checkin{
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color:#fff;
  }
  .btn-checkout{
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color:#fff;
  }
  .btn-reset{
    background: linear-gradient(135deg, #00c853 0%, #00a152 100%);
    color:#fff;
  }
</style>

<script>
  function postTo(url){
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = url;
    document.body.appendChild(form);
    form.submit();
  }

  function confirmCheckIn(bookingId){
    if(confirm(`X√°c nh·∫≠n CHECK-IN cho ƒë∆°n #${bookingId}?\n\n- Booking s·∫Ω chuy·ªÉn sang "ƒê√£ check-in"\n- Ph√≤ng s·∫Ω chuy·ªÉn sang "ƒêang s·ª≠ d·ª•ng"`)){
      postTo(`/owner/bookings/${bookingId}/checkin`);
    }
  }

  function confirmCheckOut(bookingId){
    if(confirm(`X√°c nh·∫≠n CHECK-OUT cho ƒë∆°n #${bookingId}?\n\n- Booking s·∫Ω chuy·ªÉn sang "ƒê√£ check-out"\n- Ph√≤ng s·∫Ω chuy·ªÉn sang "Ho√†n th√†nh k·ª≥"`)){
      postTo(`/owner/bookings/${bookingId}/checkout`);
    }
  }

  function confirmReset(bookingId){
    if(confirm(`Cho ƒë·∫∑t ti·∫øp theo ƒë∆°n #${bookingId}?\n\n- Booking s·∫Ω l∆∞u "RESET"\n- Ph√≤ng s·∫Ω chuy·ªÉn sang "Tr·ªëng"`)){
      postTo(`/owner/bookings/${bookingId}/reset-room`);
    }
  }
</script>

<%- include('../layout/footer.ejs') %>
