<%- include('../layout/header.ejs') %>

<link rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<main class="container-fluid section page-room-booking">
  <!-- Thông báo flash -->
  <% if (message) { %>
  <div class="alert <%= message.type %>">
    <span class="alert-icon">
      <%= message.type === 'success' ? '✅' : '⚠️' %>
    </span>
    <span class="alert-text"><%= message.mess %></span>
    <button class="alert-close"
      onclick="this.parentElement.style.display='none';">&times;</button>
  </div>
  <% } %>

  <section class="room-detail-layout">
    <div class="room-info">
      <h1><%= room.TenChoO|| room.name || 'Phòng' %></h1>

      <% if (room.HinhAnh || room.image) { %>
      <div class="room-image">
        <% const firstImage = room.HinhAnh ? room.HinhAnh.split(',')[0] :
        'default.jpg'; %>
        <img src="/admin/uploads/anhphong/<%= firstImage.trim() %>"
          alt="<%= room.TenLoaiPhong %>">
      </div>
      <% } %>

      <p class="room-price">
        Giá: <strong><%= helpers.formatMoney(room.Gia || room.price)
          %>/đêm</strong>
      </p>

      <% if (room.MoTa || room.description) { %>
      <p class="room-desc"><%= room.MoTa || room.description %></p>
      <% } %>
    </div>

    <div class="booking-panel">
      <h2>Đặt phòng này</h2>

      <form action="/rooms/<%= room.MaPhong || room.id %>/book" method="POST"
        class="form-layout" id="bookingForm">
        <input type="hidden" name="MaPhong"
          value="<%= room.MaPhong || room.id %>">

        <label class="form-field">
          <span class="label">Họ tên *</span>
          <input type="text" name="HoTen" required placeholder="Nguyễn Văn A"
            value="<%= (currentUser && currentUser.HoTen) ? currentUser.HoTen : '' %>">
        </label>

        <label class="form-field">
          <span class="label">Email</span>
          <input type="email" name="Email" placeholder="you@example.com"
            value="<%= (currentUser && currentUser.Email) ? currentUser.Email : '' %>">
        </label>

        <!--  RÀNG BUỘC SỐ ĐIỆN THOẠI -->
        <label class="form-field">
          <span class="label">Số điện thoại *</span>
          <input
            type="tel"
            name="SoDienThoai"
            id="SoDienThoai"
            required
            placeholder="090xxxxxxx"
            inputmode="numeric"
            autocomplete="tel"
            maxlength="10"
            pattern="^0[35789][0-9]{8}$"
            title="SĐT VN: 10 số, bắt đầu bằng 03/05/07/08/09"
            value="<%= (currentUser && currentUser.SDT) ? currentUser.SDT : '' %>">
          <small id="phoneHint"
            style="color:#717171; display:block; margin-top:6px;">
            Ví dụ: 0912345678 (10 số, bắt đầu 03/05/07/08/09)
          </small>
        </label>

        <div class="form-grid">
          <label class="form-field">
            <span class="label">Ngày nhận phòng *</span>
            <input type="text" id="NgayNhanPhong" name="NgayNhanPhong" required
              placeholder="YYYY-MM-DD">
          </label>

          <label class="form-field">
            <span class="label">Ngày trả phòng *</span>
            <input type="text" id="NgayTraPhong" name="NgayTraPhong" required
              placeholder="YYYY-MM-DD">
          </label>
        </div>

        <label class="form-field">
          <span class="label">Số khách (tối đa <%= room.SoKhachToiDa || 2 %> )</span>
          <input
          type="number"
          name="SoLuongKhach"
          min="1"
          max="<%= room.SoKhachToiDa || 2 %>"
          value="1"
          required
          >

        </label>

        <label class="form-field">
          <span class="label">Ghi chú</span>
          <textarea name="GhiChu" rows="3"
            placeholder="Yêu cầu thêm (nếu có)"></textarea>
        </label>

        <div class="form-actions">
          <button type="submit" class="btn primary">Xác nhận đặt
            phòng</button>
          <a href="/rooms/<%= room.MaPhong || room.id %>" class="btn">Quay lại
            chi tiết phòng</a>
        </div>
      </form>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  //  các ngày đã có người đặt (controller truyền sang)
  const disabledDates = <%- JSON.stringify(bookedDates || []) %>;

  let checkoutPicker = null;

  flatpickr("#NgayNhanPhong", {
    dateFormat: "Y-m-d",
    minDate: "today",
    disable: disabledDates,
    onChange: function(selectedDates) {
      if (!selectedDates || !selectedDates[0]) return;

      const minCheckout = new Date(selectedDates[0]);
      // tối thiểu 2 ngày
      minCheckout.setDate(minCheckout.getDate() + 2);

      if (checkoutPicker) {
        checkoutPicker.set("minDate", minCheckout);

        const cur = checkoutPicker.selectedDates && checkoutPicker.selectedDates[0];
        if (cur && cur < minCheckout) checkoutPicker.clear();
      }
    }
  });

  checkoutPicker = flatpickr("#NgayTraPhong", {
    dateFormat: "Y-m-d",
    minDate: "today",
    disable: disabledDates
  });
</script>

<!-- JS CHUẨN HOÁ + CHẶN NHẬP KÝ TỰ LẠ -->
<script>
  const phoneInput = document.getElementById('SoDienThoai');
  const form = document.getElementById('bookingForm');

  function normalizePhone(v) {
    if (!v) return '';
    let s = String(v).trim().replace(/\s|\.|-/g, '');
    // +84xxxxxxxxx hoặc 84xxxxxxxxx => 0xxxxxxxxx
    if (s.startsWith('+84')) s = '0' + s.slice(3);
    if (s.startsWith('84')) s = '0' + s.slice(2);
    // chỉ giữ số
    s = s.replace(/\D/g, '');
    return s;
  }

  function isValidVNPhone(s) {
    return /^0[35789]\d{8}$/.test(s);
  }

  // chỉ cho nhập số
  phoneInput.addEventListener('input', () => {
    const before = phoneInput.value;
    const normalized = normalizePhone(before);
    phoneInput.value = normalized.slice(0, 10);
  });

  form.addEventListener('submit', (e) => {
    const normalized = normalizePhone(phoneInput.value);
    phoneInput.value = normalized.slice(0, 10);

    if (!isValidVNPhone(phoneInput.value)) {
      e.preventDefault();
      alert('Số điện thoại không hợp lệ! Vui lòng nhập SĐT VN 10 số (03/05/07/08/09).');
      phoneInput.focus();
    }
  });
</script>

<%- include('../layout/footer.ejs') %>
