<%- include('../layout/header.ejs') %>

<main class="page-room-list">
  <section class="container section">

    <!-- Tiêu đề -->
    <header class="section-head with-action">
      <div>
        <!-- <h2>Những Nơi Lưu Trú Còn Trống</h2> -->
        <p class="section-subtitle">
          Danh sách phòng đang sẵn sàng và có thể đặt ngay tại TripStay.
        </p>
      </div>
    </header>

<!-- Thông báo flash -->
<% if (message) { %>
<div class="alert <%= message.type %>">
  <span class="alert-icon">
    <%= message.type === 'success' ? '✅' : '⚠️' %>
  </span>
  <span class="alert-text"><%= message.mess %></span>
  <button class="alert-close" onclick="this.parentElement.style.display='none';">&times;</button>
</div>
<% } %>


    <!-- THÔNG BÁO LỌC PHÒNG TRỐNG -->
    <div style="margin-bottom: 20px;">
      <!-- <span class="badge badge-success"
        style="padding: 8px 14px; font-size: 14px;">
        Đang hiển thị: Chỉ phòng Trống
      </span> -->
    </div>

    <!-- Bộ lọc và tìm kiếm -->
    <div class="filter-search-container" style="background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 32px;">
      <!-- Thanh tìm kiếm -->
      <div style="margin-bottom: 20px;">
        <input 
          type="text" 
          id="searchInput" 
          placeholder="Tìm kiếm theo tên phòng, địa chỉ, thành phố..." 
          style="width: 100%; padding: 12px 16px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; font-family: 'Inter', sans-serif; outline: none; transition: border-color 0.3s;"
          onfocus="this.style.borderColor='#FF385C'"
          onblur="this.style.borderColor='#ddd'"
        >
      </div>

      <!-- Bộ lọc -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        
        <!-- Lọc theo thành phố -->
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333;">Thành phố</label>
          <select 
            id="filterCity" 
            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif; background: #fff; cursor: pointer; outline: none;"
          >
            <option value="">Tất cả thành phố</option>
            <option value="Hà Nội">Hà Nội</option>
            <option value="Đà Nẵng">Đà Nẵng</option>
            <option value="Đà Lạt">Đà Lạt</option>
            <option value="Hồ Chí Minh">Hồ Chí Minh</option>
            <option value="Vũng Tàu">Vũng Tàu</option>
          </select>
        </div>

        <!-- Lọc theo loại phòng -->
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333;">Loại phòng</label>
          <select 
            id="filterRoomType" 
            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif; background: #fff; cursor: pointer; outline: none;"
          >
            <option value="">Tất cả loại phòng</option>
          </select>
        </div>

        <!-- Lọc theo khoảng giá -->
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333;">Khoảng giá (đêm)</label>
          <select 
            id="filterPrice" 
            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif; background: #fff; cursor: pointer; outline: none;"
          >
            <option value="">Tất cả mức giá</option>
            <option value="0-500000">Dưới 500.000đ</option>
            <option value="500000-1000000">500.000đ - 1.000.000đ</option>
            <option value="1000000-2000000">1.000.000đ - 2.000.000đ</option>
            <option value="2000000-5000000">2.000.000đ - 5.000.000đ</option>
            <option value="5000000-999999999">Trên 5.000.000đ</option>
          </select>
        </div>

        <!-- Lọc theo đánh giá -->
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333;">Đánh giá</label>
          <select 
            id="filterRating" 
            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif; background: #fff; cursor: pointer; outline: none;"
          >
            <option value="">Tất cả đánh giá</option>
            <option value="4.5">4.5 sao trở lên</option>
            <option value="4.0">4.0 sao trở lên</option>
            <option value="3.5">3.5 sao trở lên</option>
            <option value="3.0">3.0 sao trở lên</option>
          </select>
        </div>

      </div>

      <!-- Nút reset -->
      <div style="margin-top: 16px; text-align: right;">
        <button 
          id="resetFilter" 
          style="padding: 10px 24px; background: #f7f7f7; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; color: #333; font-family: 'Inter', sans-serif; transition: all 0.3s;"
          onmouseover="this.style.background='#e7e7e7'"
          onmouseout="this.style.background='#f7f7f7'"
        >
          Đặt lại bộ lọc
        </button>
      </div>
    </div>
   

    <!-- Danh sách phòng -->
   <!-- Lặp theo từng thành phố -->
<% for (const city in roomsByCity) { %>

  <% if (roomsByCity[city] && roomsByCity[city].length > 0) { %>

  <!-- H2 có link xem tất cả phòng trống tại thành phố -->
 <h2 style="margin-top: 40px;">
  <a href="/rooms/city/<%=city%>" style="color: #333; text-decoration:none;">
    Khám phá nơi lưu trú tại <%= city %>
  </a>
</h2>

  <div class="room-section">

    <% roomsByCity[city].slice(0, 5).forEach(room => { %> <!-- CHỈ LẤY 7 PHÒNG -->

      <a class="card" href="/rooms/<%= room.MaPhong %>" data-type="<%= room.TenLoaiPhong %>">

        <div class="thumb" style="position: relative;">
          <% const firstImage = room.HinhAnh ? room.HinhAnh.split(',')[0] : 'default.jpg'; %>

          <img src="admin/uploads/anhphong/<%= firstImage.trim() %>" alt="<%= room.TenLoaiPhong %>">

          <span class="badge">Được khách yêu thích</span>

          <span class="wish">
            <svg width="18" height="18" viewBox="0 0 24 24"
              fill="none" stroke="#111827" stroke-width="1.6">
              <path
                d="M12 21s-7-4.73-9.33-7.06a5.5 5.5 0 1 1 7.78-7.78L12 5.72l1.55-1.56a5.5 5.5 0 1 1 7.78 7.78C19 16.27 12 21 12 21Z" />
            </svg>
          </span>
        </div>

        <div class="card-body">
          <h3 class="title">Phòng <%= room.TenLoaiPhong %> tại <%= room.DiaChi %></h3>

          <div class="meta">
            <%= helpers.formatMoney(room.Gia) %>đ / đêm · ★
            <%= room.Rating || 'Chưa có' %>
          </div>
        </div>

      </a>

    <% }) %>

  </div>

  <% } %>

<% } %>


  </section>

  <!-- Script lọc và tìm kiếm phòng -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Lấy các phần tử
      const searchInput = document.getElementById('searchInput');
      const filterCity = document.getElementById('filterCity');
      const filterRoomType = document.getElementById('filterRoomType');
      const filterPrice = document.getElementById('filterPrice');
      const filterRating = document.getElementById('filterRating');
      const resetFilter = document.getElementById('resetFilter');
      
      // Lấy tất cả các card phòng
      const roomCards = document.querySelectorAll('.card');
      const roomSections = document.querySelectorAll('.room-section');
      const cityHeaders = document.querySelectorAll('h2');

      // Thu thập danh sách loại phòng từ dữ liệu hiện có
      const roomTypes = new Set();
      roomCards.forEach(card => {
        const roomType = card.getAttribute('data-type');
        if (roomType) roomTypes.add(roomType);
      });

      // Thêm các loại phòng vào select
      roomTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        filterRoomType.appendChild(option);
      });

      // Hàm lọc phòng
      function filterRooms() {
        const searchText = searchInput.value.toLowerCase().trim();
        const selectedCity = filterCity.value;
        const selectedRoomType = filterRoomType.value;
        const selectedPrice = filterPrice.value;
        const selectedRating = filterRating.value;

        let visibleCount = 0;

        roomCards.forEach(card => {
          // Lấy thông tin phòng từ card
          const title = card.querySelector('.title')?.textContent.toLowerCase() || '';
          const meta = card.querySelector('.meta')?.textContent.toLowerCase() || '';
          const roomType = card.getAttribute('data-type') || '';
          
          // Lấy giá từ meta (format: X.XXX.XXXđ / đêm)
          const priceMatch = meta.match(/([\d.]+)đ/);
          const price = priceMatch ? parseInt(priceMatch[1].replace(/\./g, '')) : 0;
          
          // Lấy rating từ meta (format: ★ X.XX)
          const ratingMatch = meta.match(/★\s*([\d.]+)/);
          const rating = ratingMatch ? parseFloat(ratingMatch[1]) : 0;

          // Kiểm tra điều kiện tìm kiếm
          let matchSearch = true;
          if (searchText) {
            matchSearch = title.includes(searchText) || meta.includes(searchText);
          }

          // Kiểm tra điều kiện lọc thành phố
          let matchCity = true;
          if (selectedCity) {
            matchCity = title.includes(selectedCity.toLowerCase());
          }

          // Kiểm tra điều kiện lọc loại phòng
          let matchRoomType = true;
          if (selectedRoomType) {
            matchRoomType = roomType === selectedRoomType;
          }

          // Kiểm tra điều kiện lọc giá
          let matchPrice = true;
          if (selectedPrice) {
            const [minPrice, maxPrice] = selectedPrice.split('-').map(p => parseInt(p));
            matchPrice = price >= minPrice && price <= maxPrice;
          }

          // Kiểm tra điều kiện lọc rating
          let matchRating = true;
          if (selectedRating) {
            const minRating = parseFloat(selectedRating);
            matchRating = rating >= minRating;
          }

          // Hiển thị hoặc ẩn card
          if (matchSearch && matchCity && matchRoomType && matchPrice && matchRating) {
            card.style.display = 'flex';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        });

        // Ẩn/hiện các section theo thành phố
        roomSections.forEach((section, index) => {
          const cardsInSection = section.querySelectorAll('.card');
          const visibleCardsInSection = Array.from(cardsInSection).filter(card => card.style.display !== 'none');
          
          if (visibleCardsInSection.length > 0) {
            section.style.display = 'grid';
            if (cityHeaders[index]) cityHeaders[index].style.display = 'block';
          } else {
            section.style.display = 'none';
            if (cityHeaders[index]) cityHeaders[index].style.display = 'none';
          }
        });

        // Hiển thị thông báo nếu không có kết quả
        let noResultMsg = document.getElementById('noResultMessage');
        if (visibleCount === 0) {
          if (!noResultMsg) {
            noResultMsg = document.createElement('div');
            noResultMsg.id = 'noResultMessage';
            noResultMsg.style.cssText = 'text-align: center; padding: 40px; background: #f9f9f9; border-radius: 12px; margin-top: 20px;';
            noResultMsg.innerHTML = '<h3 style="color: #666; font-size: 18px; margin-bottom: 8px;">Không tìm thấy phòng phù hợp</h3><p style="color: #999; font-size: 14px;">Vui lòng thử lại với điều kiện tìm kiếm khác</p>';
            document.querySelector('.section').appendChild(noResultMsg);
          }
          noResultMsg.style.display = 'block';
        } else {
          if (noResultMsg) noResultMsg.style.display = 'none';
        }
      }

      // Gắn sự kiện
      searchInput.addEventListener('input', filterRooms);
      filterCity.addEventListener('change', filterRooms);
      filterRoomType.addEventListener('change', filterRooms);
      filterPrice.addEventListener('change', filterRooms);
      filterRating.addEventListener('change', filterRooms);

      // Reset bộ lọc
      resetFilter.addEventListener('click', () => {
        searchInput.value = '';
        filterCity.value = '';
        filterRoomType.value = '';
        filterPrice.value = '';
        filterRating.value = '';
        filterRooms();
      });
    });
  </script>
</main>

<%- include('../layout/footer.ejs') %>
