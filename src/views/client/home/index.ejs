<%- include('../layout/header.ejs') %>

<main class="page-room-list">
  <section class="container section">

    <!-- Ti√™u ƒë·ªÅ -->
    <header class="section-head with-action">
      <div>
       
      </div>
    </header>

<!-- Th√¥ng b√°o flash -->
<% if (message) { %>
<div class="alert <%= message.type %>">
  <span class="alert-icon">
    <%= message.type === 'success' ? '‚úÖ' : '‚ö†Ô∏è' %>
  </span>
  <span class="alert-text"><%= message.mess %></span>
  <button class="alert-close" onclick="this.parentElement.style.display='none';">&times;</button>
</div>
<% } %>


    <!-- TH√îNG B√ÅO L·ªåC PH√íNG TR·ªêNG -->
    <div style="margin-bottom: 20px;">
      <!-- <span class="badge badge-success"
        style="padding: 8px 14px; font-size: 14px;">
        ƒêang hi·ªÉn th·ªã: Ch·ªâ ph√≤ng Tr·ªëng
      </span> -->
    </div>

    <!-- B·ªô l·ªçc theo lo·∫°i ph√≤ng -->
    <!-- B·ªô l·ªçc v√† t√¨m ki·∫øm -->
    <div class="filter-search-container" style="background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 32px;">
      <!-- Thanh t√¨m ki·∫øm -->
      <div style="margin-bottom: 20px;">
        <input 
          type="text" 
          id="searchInput" 
          placeholder="T√¨m ki·∫øm theo t√™n ph√≤ng, ƒë·ªãa ch·ªâ, th√†nh ph·ªë..." 
          style="width: 100%; padding: 12px 16px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; font-family: 'Inter', sans-serif; outline: none; transition: border-color 0.3s;"
          onfocus="this.style.borderColor='#FF385C'"
          onblur="this.style.borderColor='#ddd'"
        >
      </div>

      <!-- B·ªô l·ªçc -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">

        <!-- L·ªçc theo th√†nh ph·ªë -->
       

        <!-- L·ªçc theo lo·∫°i ph√≤ng -->
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333;">Lo·∫°i ph√≤ng</label>
          <select 
            id="filterRoomType" 
            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif; background: #fff; cursor: pointer; outline: none;"
          >
            <option value="">T·∫•t c·∫£ lo·∫°i ph√≤ng</option>
            <% if (allRoomTypes && allRoomTypes.length > 0) { %>
              <% allRoomTypes.forEach(roomType => { %>
                <option value="<%= roomType.TenLoaiPhong %>"><%= roomType.TenLoaiPhong %></option>
              <% }); %>
            <% } %>
          </select>
        </div>

        <!-- L·ªçc theo kho·∫£ng gi√° -->
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333;">Kho·∫£ng gi√° (ƒë√™m)</label>
          <select 
            id="filterPrice" 
            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif; background: #fff; cursor: pointer; outline: none;"
          >
            <option value="">T·∫•t c·∫£ m·ª©c gi√°</option>
            <option value="0-500000">D∆∞·ªõi 500.000ƒë</option>
            <option value="500000-1000000">500.000ƒë - 1.000.000ƒë</option>
            <option value="1000000-2000000">1.000.000ƒë - 2.000.000ƒë</option>
            <option value="2000000-5000000">2.000.000ƒë - 5.000.000ƒë</option>
            <option value="5000000-999999999">Tr√™n 5.000.000ƒë</option>
          </select>
        </div>

        <!-- L·ªçc theo ƒë√°nh gi√° -->
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #333;">ƒê√°nh gi√°</label>
          <select 
            id="filterRating" 
            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif; background: #fff; cursor: pointer; outline: none;"
          >
            <option value="">T·∫•t c·∫£ ƒë√°nh gi√°</option>
            <option value="4.5">4.5 sao tr·ªü l√™n</option>
            <option value="4.0">4.0 sao tr·ªü l√™n</option>
            <option value="3.5">3.5 sao tr·ªü l√™n</option>
            <option value="3.0">3.0 sao tr·ªü l√™n</option>
          </select>
        </div>

      </div>

      <!-- N√∫t reset -->
      <div style="margin-top: 16px; text-align: right;">
        <button 
          id="resetFilter" 
          style="padding: 10px 24px; background: #f7f7f7; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; color: #333; font-family: 'Inter', sans-serif; transition: all 0.3s;"
          onmouseover="this.style.background='#e7e7e7'"
          onmouseout="this.style.background='#f7f7f7'"
        >
          ƒê·∫∑t l·∫°i b·ªô l·ªçc
        </button>
      </div>
    </div>


     <div class="location-showcase">
    <!-- Header -->
    <div class="showcase-header">
      <h3 class="showcase-title">
        ƒê·ªãa ƒëi·ªÉm n·ªïi b·∫≠t
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </h3>
      <div class="showcase-nav">
        <button class="nav-arrow" id="prevBtn" aria-label="Previous">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button class="nav-arrow" id="nextBtn" aria-label="Next">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Carousel -->
    <div class="carousel-wrapper">
      <div class="carousel-track" id="carouselTrack">
        <!-- Card 1 -->
       
  <a href="/rooms/city-slug/thanh-pho-ho-chi-minh" class="location-link">
    <div class="location-card">
      <div class="location-image">
        <img src="https://images.unsplash.com/photo-1522771739844-6a9f6d5f14af?w=600&h=400&fit=crop">
        <span class="favorite-badge">ƒê∆∞·ª£c kh√°ch y√™u th√≠ch</span>
      </div>
      <div class="location-info">
        <div class="location-name">Th√†nh ph·ªë H·ªì Ch√≠ Minh</div>
        <div class="location-meta">
          <span>1 gi∆∞·ªùng</span> ‚Ä¢
          <span class="location-rating">‚òÖ 5.0</span>
        </div>
      </div>
    </div>
  </a>

  <!-- Card 2 -->
  <a href="/rooms/city-slug/ha-noi" class="location-link">
    <div class="location-card">
      <div class="location-image">
        <img src="https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=600&h=400&fit=crop">
        <span class="favorite-badge">ƒê∆∞·ª£c kh√°ch y√™u th√≠ch</span>
      </div>
      <div class="location-info">
        <div class="location-name">H√† N·ªôi</div>
        <div class="location-meta">
          <span>1 gi∆∞·ªùng</span> ‚Ä¢
          <span class="location-rating">‚òÖ 4.93</span>
        </div>
      </div>
    </div>
  </a>

  <!-- Card 3 -->
  <a href="/rooms/city-slug/da-lat" class="location-link">
    <div class="location-card">
      <div class="location-image">
        <img src="https://images.unsplash.com/photo-1564501049412-61c2a3083791?w=600&h=400&fit=crop">
        <span class="favorite-badge">ƒê∆∞·ª£c kh√°ch y√™u th√≠ch</span>
      </div>
      <div class="location-info">
        <div class="location-name">ƒê√† L·∫°t</div>
        <div class="location-meta">
          <span>1 gi∆∞·ªùng</span> ‚Ä¢
          <span class="location-rating">‚òÖ 5.0</span>
        </div>
      </div>
    </div>
  </a>

  <!-- Card 4 -->
  <a href="/rooms/city-slug/hoi-an" class="location-link">
    <div class="location-card">
      <div class="location-image">
        <img src="https://images.unsplash.com/photo-1566073771259-6a8506099945?w=600&h=400&fit=crop">
        <span class="favorite-badge">ƒê∆∞·ª£c kh√°ch y√™u th√≠ch</span>
      </div>
      <div class="location-info">
        <div class="location-name">H·ªôi An</div>
        <div class="location-meta">
          <span>1 gi∆∞·ªùng</span> ‚Ä¢
          <span class="location-rating">‚òÖ 4.88</span>
        </div>
      </div>
    </div>
  </a>

  <!-- Card 5 -->
  <a href="/rooms/city-slug/vung-tau" class="location-link">
    <div class="location-card">
      <div class="location-image">
        <img src="https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=600&h=400&fit=crop">
        <span class="favorite-badge">ƒê∆∞·ª£c kh√°ch y√™u th√≠ch</span>
      </div>
      <div class="location-info">
        <div class="location-name">V≈©ng T√†u</div>
        <div class="location-meta">
          <span>1 gi∆∞·ªùng</span> ‚Ä¢
          <span class="location-rating">‚òÖ 4.97</span>
        </div>
      </div>
    </div>
  </a>

  <!-- Card 6 -->
  <a href="/rooms/city-slug/nha-trang" class="location-link">
    <div class="location-card">
      <div class="location-image">
        <img src="https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=600&h=400&fit=crop">
        <span class="favorite-badge">ƒê∆∞·ª£c kh√°ch y√™u th√≠ch</span>
      </div>
      <div class="location-info">
        <div class="location-name">Nha Trang</div>
        <div class="location-meta">
          <span>1 gi∆∞·ªùng</span> ‚Ä¢
          <span class="location-rating">‚òÖ 4.92</span>
        </div>
      </div>
    </div>
  </a>

        
      </div>
    </div>
  </div>

    <!-- Danh s√°ch ph√≤ng -->
   <!-- L·∫∑p theo t·ª´ng th√†nh ph·ªë -->
<% for (const city in roomsByCity) { %>

  <% if (roomsByCity[city] && roomsByCity[city].length > 0) { %>

  <!-- H2 c√≥ link xem t·∫•t c·∫£ ph√≤ng tr·ªëng t·∫°i th√†nh ph·ªë -->
 <h2 style="margin-top: 40px;">
  <a href="/rooms/city/<%=city%>" style="color: #333; text-decoration:none;">
    Kh√°m ph√° n∆°i l∆∞u tr√∫ t·∫°i <%= city %>
  </a>
</h2>

  <div class="room-section">

    <% roomsByCity[city].slice(0, 6).forEach(room => { %> <!-- CH·ªà L·∫§Y 6 PH√íNG -->

      <a class="card" href="/rooms/<%= room.MaPhong %>" data-type="<%= room.TenLoaiPhong %>" data-city="<%= room.ThanhPho %>">

        <div class="thumb" style="position: relative;">
          <% const firstImage = room.HinhAnh ? room.HinhAnh.split(',')[0] : 'default.jpg'; %>

          <img src="admin/uploads/anhphong/<%= firstImage.trim() %>" alt="<%= room.TenLoaiPhong %>">

          <span class="badge">ƒê∆∞·ª£c kh√°ch y√™u th√≠ch</span>

          <span class="wish">
            <svg width="18" height="18" viewBox="0 0 24 24"
              fill="none" stroke="#111827" stroke-width="1.6">
              <path
                d="M12 21s-7-4.73-9.33-7.06a5.5 5.5 0 1 1 7.78-7.78L12 5.72l1.55-1.56a5.5 5.5 0 1 1 7.78 7.78C19 16.27 12 21 12 21Z" />
            </svg>
          </span>
        </div>

        <div class="card-body">
          <h3 class="title">Ph√≤ng <%= room.TenChoO %> t·∫°i <%= room.District %>, <%=room.ThanhPho %></h3>

          <div class="meta">
            <%= helpers.formatMoney(room.Gia) %>ƒë / ƒë√™m ¬∑ ‚òÖ
            <%= room.Rating || 'Ch∆∞a c√≥' %>
          </div>
        </div>

      </a>

    <% }) %>

<a class="card see-all-card" href="/rooms/city/<%=city%>">
  
  <div class="collage-group">
    <% 
      // Logic ƒë∆°n gi·∫£n: L·∫•y 3 ·∫£nh b·∫•t k·ª≥ t·ª´ danh s√°ch ph√≤ng hi·ªán c√≥
      // N·∫øu kh√¥ng c√≥ ·∫£nh th√¨ d√πng 'default.jpg'
      let images = [];
      roomsByCity[city].forEach(r => {
         if (r.HinhAnh && images.length < 3) {
            images.push(r.HinhAnh.split(',')[0].trim());
         }
      });
      // N·∫øu ch∆∞a ƒë·ªß 3 ·∫£nh th√¨ fill th√™m cho ƒë·ªß (ƒë·ªÉ giao di·ªán kh√¥ng b·ªã l·ªói)
      while (images.length < 3) { images.push('default.jpg'); }
    %>

    <% images.forEach((img, i) => { %>
      <div class="collage-item item-<%= i %>">
        <img src="admin/uploads/anhphong/<%= img %>" alt="Room image">
      </div>
    <% }) %>
  </div>

  <div class="see-all-text">Xem t·∫•t c·∫£</div>
</a>
      
  </div>

  <% } %>

<% } %>


  </section>

   <script>
    document.addEventListener('DOMContentLoaded', () => {
      // L·∫•y c√°c ph·∫ßn t·ª≠
      const searchInput = document.getElementById('searchInput');
      //const filterCity = document.getElementById('filterCity');
      const filterRoomType = document.getElementById('filterRoomType');
      const filterPrice = document.getElementById('filterPrice');
      const filterRating = document.getElementById('filterRating');
      const resetFilter = document.getElementById('resetFilter');
      
      let debounceTimer;

      // H√†m l·ªçc ph√≤ng t·ª´ DATABASE
      async function filterRooms() {
  const searchText = searchInput.value.trim();
  const selectedRoomType = filterRoomType.value;
  const selectedPrice = filterPrice.value;
  const selectedRating = filterRating.value;

  const params = new URLSearchParams();

  if (searchText) params.append('search', searchText);
  if (selectedRoomType) params.append('roomType', selectedRoomType);
  if (selectedPrice) params.append('priceRange', selectedPrice);
  if (selectedRating) params.append('rating', selectedRating);

  try {
    showLoading(true);

    const response = await fetch(`/api/search-rooms?${params.toString()}`);
    const result = await response.json();

    if (result.success) {
      renderRooms(result.data);
    } else {
      showError('C√≥ l·ªói x·∫£y ra khi t√¨m ki·∫øm ph√≤ng');
    }
  } catch (err) {
    console.error(err);
    showError('Kh√¥ng th·ªÉ k·∫øt n·ªëi server');
  } finally {
    showLoading(false);
  }
}


      // H√†m render danh s√°ch ph√≤ng
      function renderRooms(rooms) {
        const section = document.querySelector('.section');
        
        // X√≥a c√°c section c≈© (tr·ª´ header v√† filter)
        const oldH2s = section.querySelectorAll('h2');
         const oldH3s = section.querySelectorAll('h3');
        const oldSections = section.querySelectorAll('.room-section');
        const oldNoResult = document.getElementById('noResultMessage');
        const oldSections2 = section.querySelectorAll('.carousel-wrapper');
        const oldSections3 = section.querySelectorAll('.showcase-header');
        
        oldSections2.forEach(sec => sec.remove());
        oldSections3.forEach(sec => sec.remove());
        oldH3s.forEach(h2 => h2.remove());
        oldH2s.forEach(h2 => h2.remove());
        oldSections.forEach(sec => sec.remove());
        if (oldNoResult) oldNoResult.remove();

        if (rooms.length === 0) {
          // Hi·ªÉn th·ªã th√¥ng b√°o kh√¥ng c√≥ k·∫øt qu·∫£
          const noResultMsg = document.createElement('div');
          noResultMsg.id = 'noResultMessage';
          noResultMsg.style.cssText = 'text-align: center; padding: 40px; background: #f9f9f9; border-radius: 12px; margin-top: 20px;';
          noResultMsg.innerHTML = '<h3 style="color: #666; font-size: 18px; margin-bottom: 8px;">Kh√¥ng t√¨m th·∫•y ph√≤ng ph√π h·ª£p</h3><p style="color: #999; font-size: 14px;">Vui l√≤ng th·ª≠ l·∫°i v·ªõi ƒëi·ªÅu ki·ªán t√¨m ki·∫øm kh√°c</p>';
          section.appendChild(noResultMsg);
          return;
        }

        // Nh√≥m ph√≤ng theo th√†nh ph·ªë
        const roomsByCity = {};
        rooms.forEach(room => {
          const city = room.ThanhPho || 'Kh√°c';
          if (!roomsByCity[city]) roomsByCity[city] = [];
          roomsByCity[city].push(room);
        });

        // Render t·ª´ng nh√≥m th√†nh ph·ªë
        Object.keys(roomsByCity).forEach(city => {
          const cityRooms = roomsByCity[city];
          
          // T·∫°o H2
          const h2 = document.createElement('h2');
          h2.style.marginTop = '40px';
          h2.innerHTML = `<a href="/rooms/city/${city}" style="color: #333; text-decoration:none;">Kh√°m ph√° n∆°i l∆∞u tr√∫ t·∫°i ${city}</a>`;
          section.appendChild(h2);

          // T·∫°o room-section
          const roomSection = document.createElement('div');
          roomSection.className = 'room-section';
          
          // Render t·ª´ng ph√≤ng
          cityRooms.forEach(room => {
            const firstImage = room.HinhAnh ? room.HinhAnh.split(',')[0].trim() : 'default.jpg';
            
            const card = document.createElement('a');
            card.className = 'card';
            card.href = `/rooms/${room.MaPhong}`;
            card.setAttribute('data-type', room.TenLoaiPhong);
            card.setAttribute('data-city', room.ThanhPho);
            
            card.innerHTML = `
              <div class="thumb" style="position: relative;">
                <img src="admin/uploads/anhphong/${firstImage}" alt="${room.TenLoaiPhong}">
                <span class="badge">ƒê∆∞·ª£c kh√°ch y√™u th√≠ch</span>
                <span class="wish">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.6">
                    <path d="M12 21s-7-4.73-9.33-7.06a5.5 5.5 0 1 1 7.78-7.78L12 5.72l1.55-1.56a5.5 5.5 0 1 1 7.78 7.78C19 16.27 12 21 12 21Z" />
                  </svg>
                </span>
              </div>
              <div class="card-body">
                <h3 class="title">Ph√≤ng ${room.TenChoO} t·∫°i ${room.District},${room.ThanhPho} </h3>
                <div class="meta">
                  ${formatMoney(room.Gia)}ƒë / ƒë√™m ¬∑ ‚òÖ ${room.Rating || 'Ch∆∞a c√≥'}
                </div>
              </div>
            `;
            
            roomSection.appendChild(card);
          });
          
          section.appendChild(roomSection);
        });
      }

      // H√†m format ti·ªÅn
      function formatMoney(amount) {
        return new Intl.NumberFormat('vi-VN').format(amount);
      }

      // H√†m hi·ªÉn th·ªã loading
      function showLoading(show) {
        let loader = document.getElementById('loadingSpinner');
        if (show) {
          if (!loader) {
            loader = document.createElement('div');
            loader.id = 'loadingSpinner';
            loader.style.cssText = 'text-align: center; padding: 40px; color: #666;';
            loader.innerHTML = '<div style="font-size: 24px;">üîç</div><p>ƒêang t√¨m ki·∫øm...</p>';
            document.querySelector('.section').appendChild(loader);
          }
          loader.style.display = 'block';
        } else {
          if (loader) loader.style.display = 'none';
        }
      }

      // H√†m hi·ªÉn th·ªã l·ªói
      function showError(message) {
        alert(message);
      }

      // Debounce cho search input
      if (searchInput) {
        searchInput.addEventListener('input', () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(filterRooms, 500);
        });
      }

      // G·∫Øn s·ª± ki·ªán cho c√°c filter
      //if (filterCity) filterCity.addEventListener('change', filterRooms);
      if (filterRoomType) filterRoomType.addEventListener('change', filterRooms);
      if (filterPrice) filterPrice.addEventListener('change', filterRooms);
      if (filterRating) filterRating.addEventListener('change', filterRooms);

      // Reset b·ªô l·ªçc
      if (resetFilter) {
        resetFilter.addEventListener('click', () => {
          if (searchInput) searchInput.value = '';
          //if (filterCity) filterCity.value = '';
          if (filterRoomType) filterRoomType.value = '';
          if (filterPrice) filterPrice.value = '';
          if (filterRating) filterRating.value = '';
          location.reload(); // Reload trang ƒë·ªÉ l·∫•y d·ªØ li·ªáu g·ªëc
        });
      }
    });
  </script>
  <script>
    const track = document.getElementById('carouselTrack');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    const scrollAmount = 320; // width of card + gap

    prevBtn.addEventListener('click', () => {
      track.scrollBy({
        left: -scrollAmount,
        behavior: 'smooth'
      });
    });

    nextBtn.addEventListener('click', () => {
      track.scrollBy({
        left: scrollAmount,
        behavior: 'smooth'
      });
    });

    // Optional: Add click handlers to cards
    const cards = document.querySelectorAll('.location-card');
    cards.forEach(card => {
      card.addEventListener('click', (e) => {
        // Prevent navigation if clicking heart icon
        if (!e.target.closest('.heart-icon')) {
          console.log('Card clicked:', card.querySelector('.location-name').textContent);
          // Add your navigation logic here
        }
      });
    });

    // Heart icon toggle
    const heartIcons = document.querySelectorAll('.heart-icon');
    heartIcons.forEach(heart => {
      heart.addEventListener('click', (e) => {
        e.stopPropagation();
        const svg = heart.querySelector('svg');
        const currentFill = svg.getAttribute('fill');
        
        if (currentFill === 'none' || !currentFill) {
          svg.setAttribute('fill', '#ff385c');
          svg.setAttribute('stroke', '#ff385c');
        } else {
          svg.setAttribute('fill', 'none');
          svg.setAttribute('stroke', '#fff');
        }
      });
    });
  </script>
</main>

<%- include('../layout/footer.ejs') %>
